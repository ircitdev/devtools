# Техническое задание: InstaLeadMagnitBot

## 1. Общее описание проекта

**Название:** InstaLeadMagnitBot

**Цель:** Автоматизация лидогенерации в Instagram путём отслеживания ключевых слов в комментариях к постам и автоматической отправки персонализированных сообщений в Direct.

**Принцип работы:**
1. Пользователь оставляет комментарий под постом с ключевым словом (например, "ХОЧУ", "ЦЕНА", "ПОДРОБНЕЕ")
2. Бот обнаруживает ключевое слово
3. Бот автоматически отправляет заранее настроенное сообщение в Direct этому пользователю

---

## 2. Функциональные требования

### 2.1. Модуль мониторинга комментариев

- Отслеживание новых комментариев к указанным постам
- Поддержка нескольких постов одновременно
- Фильтрация комментариев по ключевым словам (без учёта регистра)
- Исключение повторной обработки уже обработанных комментариев
- Защита от спама (один пользователь = одно сообщение на пост)

### 2.2. Модуль отправки сообщений в Direct

- Автоматическая отправка сообщений при срабатывании триггера
- Поддержка задержки между отправками (anti-spam)
- Персонализация сообщений (имя пользователя, упоминание поста)
- Логирование всех отправленных сообщений
- Очередь сообщений для предотвращения блокировки

### 2.3. Админ-панель (Telegram Bot)

**Управление ключевыми словами:**
- Добавление/удаление/редактирование ключевых слов
- Привязка ключевого слова к конкретному сообщению
- Включение/выключение отдельных триггеров

**Управление сообщениями:**
- Создание шаблонов сообщений
- Поддержка переменных: `{username}`, `{post_url}`, `{keyword}`
- Предпросмотр сообщения перед сохранением

**Управление постами:**
- Добавление постов для мониторинга по URL или ID
- Просмотр списка отслеживаемых постов
- Удаление постов из мониторинга

**Статистика:**
- Количество обработанных комментариев
- Количество отправленных сообщений
- Статистика по ключевым словам
- Конверсия (комментарии → сообщения)

### 2.4. Система правил (Rules Engine)

```json
{
  "id": "uuid",
  "post_id": "instagram_post_id | all",
  "keywords": ["слово1", "слово2"],
  "match_type": "exact | contains | regex",
  "message_template_id": "uuid",
  "is_active": true,
  "cooldown_hours": 24,
  "created_at": "timestamp"
}
```

---

## 3. Технические требования

### 3.1. Стек технологий

| Компонент | Технология |
|-----------|------------|
| Backend | Python 3.11+ |
| Instagram API | instagrapi |
| База данных | SQLite (dev) / PostgreSQL (prod) |
| Очередь задач | Celery + Redis |
| Админ-панель | Telegram Bot (python-telegram-bot) |
| Конфигурация | python-dotenv |
| Логирование | loguru |

### 3.2. Архитектура

```
InstaLeadMagnitBot/
├── src/
│   ├── __init__.py
│   ├── main.py                 # Точка входа
│   ├── config.py               # Конфигурация
│   ├── instagram/
│   │   ├── __init__.py
│   │   ├── client.py           # Instagram API клиент
│   │   ├── monitor.py          # Мониторинг комментариев
│   │   └── messenger.py        # Отправка Direct
│   ├── core/
│   │   ├── __init__.py
│   │   ├── rules.py            # Движок правил
│   │   ├── matcher.py          # Сопоставление ключевых слов
│   │   └── scheduler.py        # Планировщик задач
│   ├── database/
│   │   ├── __init__.py
│   │   ├── models.py           # SQLAlchemy модели
│   │   └── repository.py       # Репозитории
│   ├── admin/
│   │   ├── __init__.py
│   │   ├── bot.py              # Telegram бот
│   │   └── handlers/           # Обработчики команд
│   └── utils/
│       ├── __init__.py
│       └── helpers.py
├── tests/
├── .env.example
├── requirements.txt
├── docker-compose.yml
└── README.md
```

### 3.3. База данных (схема)

**Таблица: posts**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| instagram_id | VARCHAR | ID поста в Instagram |
| url | VARCHAR | URL поста |
| is_active | BOOLEAN | Активен ли мониторинг |
| created_at | TIMESTAMP | Дата добавления |

**Таблица: keywords**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| word | VARCHAR | Ключевое слово |
| match_type | ENUM | exact/contains/regex |
| is_active | BOOLEAN | Активно ли |

**Таблица: message_templates**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| name | VARCHAR | Название шаблона |
| content | TEXT | Текст сообщения |
| created_at | TIMESTAMP | Дата создания |

**Таблица: rules**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| post_id | UUID FK | Связь с постом (nullable = все посты) |
| keyword_id | UUID FK | Связь с ключевым словом |
| template_id | UUID FK | Связь с шаблоном |
| cooldown_hours | INT | Задержка повторной отправки |
| is_active | BOOLEAN | Активно ли правило |

**Таблица: sent_messages**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| user_id | VARCHAR | Instagram user ID |
| username | VARCHAR | Instagram username |
| post_id | UUID FK | К какому посту |
| rule_id | UUID FK | Какое правило сработало |
| sent_at | TIMESTAMP | Когда отправлено |
| status | ENUM | sent/failed/pending |

**Таблица: processed_comments**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Primary key |
| comment_id | VARCHAR | Instagram comment ID |
| processed_at | TIMESTAMP | Когда обработан |

---

## 4. Безопасность и ограничения

### 4.1. Лимиты Instagram API
- Максимум 50-100 DM в час (настраиваемо)
- Задержка между сообщениями: 30-60 секунд
- Проверка комментариев: каждые 30-60 секунд
- Ротация прокси (опционально)

### 4.2. Защита аккаунта
- Хранение сессии для избежания частых логинов
- Обработка challenge/verification
- Уведомление админа при проблемах с аккаунтом
- Автоматическая пауза при подозрительной активности

### 4.3. Конфиденциальность
- Хранение credentials в .env файле
- Шифрование чувствительных данных в БД
- Логирование без персональных данных

---

## 5. Команды Telegram-бота (Админ-панель)

```
/start - Начало работы
/status - Статус бота и статистика

# Посты
/posts - Список отслеживаемых постов
/add_post <url> - Добавить пост
/remove_post <id> - Удалить пост

# Ключевые слова
/keywords - Список ключевых слов
/add_keyword <слово> - Добавить слово
/remove_keyword <id> - Удалить слово

# Шаблоны сообщений
/templates - Список шаблонов
/add_template - Создать шаблон (интерактивно)
/edit_template <id> - Редактировать шаблон
/preview_template <id> - Предпросмотр

# Правила
/rules - Список правил
/add_rule - Создать правило (интерактивно)
/toggle_rule <id> - Вкл/выкл правило

# Управление
/pause - Приостановить бота
/resume - Возобновить работу
/logs - Последние события
```

---

## 6. Переменные окружения (.env)

```env
# Instagram
INSTAGRAM_USERNAME=your_username
INSTAGRAM_PASSWORD=your_password

# Telegram Admin Bot
TELEGRAM_BOT_TOKEN=your_bot_token
ADMIN_TELEGRAM_IDS=123456789,987654321

# Database
DATABASE_URL=sqlite:///./bot.db

# Redis (для очереди)
REDIS_URL=redis://localhost:6379/0

# Настройки бота
CHECK_INTERVAL_SECONDS=60
MESSAGE_DELAY_SECONDS=45
MAX_MESSAGES_PER_HOUR=50
COOLDOWN_HOURS=24

# Прокси (опционально)
PROXY_URL=
```

---

## 7. Примеры использования

### Сценарий 1: Раздача лид-магнита
1. Админ создаёт пост: "Напиши ГАЙД в комментариях и получи бесплатный чек-лист!"
2. Добавляет пост в мониторинг
3. Создаёт ключевое слово "ГАЙД"
4. Создаёт шаблон: "Привет, {username}! Держи обещанный чек-лист: [ссылка]"
5. Связывает правило: пост + слово + шаблон
6. Бот автоматически отправляет гайд всем, кто написал "ГАЙД"

### Сценарий 2: Мультитриггеры
- "ЦЕНА" → отправка прайс-листа
- "ЗАПИСАТЬСЯ" → отправка ссылки на запись
- "ПОДРОБНЕЕ" → отправка полного описания услуги

---

## 8. Этапы разработки

### Этап 1: MVP (Базовый функционал)
- [ ] Подключение к Instagram API
- [ ] Мониторинг комментариев одного поста
- [ ] Отправка сообщений в Direct
- [ ] Базовое хранение в SQLite
- [ ] Простые команды в Telegram

### Этап 2: Расширенный функционал
- [ ] Множественные посты и правила
- [ ] Полноценная админ-панель
- [ ] Статистика и аналитика
- [ ] Система шаблонов с переменными

### Этап 3: Production-ready
- [ ] Очередь задач (Celery)
- [ ] PostgreSQL
- [ ] Docker-контейнеризация
- [ ] Мониторинг и алерты
- [ ] Документация API

---

## 9. Риски и ограничения

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Блокировка аккаунта Instagram | Средняя | Соблюдение лимитов, прогрев аккаунта |
| Изменение Instagram API | Высокая | Использование актуальных библиотек |
| Spam-фильтры Instagram | Средняя | Вариативность сообщений, задержки |
| Потеря сессии | Низкая | Автоматическое восстановление |

---

## 10. Критерии приёмки

- [ ] Бот успешно авторизуется в Instagram
- [ ] Комментарии отслеживаются в реальном времени
- [ ] Сообщения отправляются корректно
- [ ] Админ-панель полностью функциональна
- [ ] Нет дублирования сообщений
- [ ] Статистика корректно отображается
- [ ] Система работает стабильно 24/7
